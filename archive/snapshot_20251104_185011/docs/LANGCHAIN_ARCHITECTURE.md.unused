# LangChain Architecture Diagram

## System Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         USER REQUEST                                 │
│  "What families am I in?" or "Buy avatar X"                         │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     FastAPI Endpoint                                 │
│  POST /api/v1/ai/chat                                               │
│  - Validate user authentication                                     │
│  - Create MCPUserContext                                            │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  LangChainOrchestrator                              │
│  orchestrator.py                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ 1. Get or create agent for user                              │  │
│  │ 2. Load conversation history from Redis                      │  │
│  │ 3. Execute agent with message                                │  │
│  │ 4. Save response to history                                  │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐    ┌──────────────────┐    ┌─────────────────┐
│  LangGraph    │    │   Redis Memory   │    │  Tool Creation  │
│  ReAct Agent  │    │                  │    │                 │
│               │    │  Session History │    │  53 MCP Tools   │
└───────┬───────┘    └──────────────────┘    └────────┬────────┘
        │                                              │
        │  ┌───────────────────────────────────────────┘
        │  │
        ▼  ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    AGENT EXECUTION LOOP                              │
│  LangGraph ReAct Pattern                                            │
│                                                                      │
│  Step 1: THOUGHT                                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ LLM (Ollama llama3.2:1b)                                     │   │
│  │ Input: System + History + User message                       │   │
│  │ Output: Reasoning about what to do                           │   │
│  │         Decision on which tool to use                        │   │
│  └────────────────────────────────────────────────────────────┘   │
│         │                                                            │
│         ▼                                                            │
│  Step 2: ACTION                                                     │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ Tool Selection                                               │   │
│  │ - Choose tool: get_family_info                              │   │
│  │ - Prepare parameters: {family_id: "123"}                    │   │
│  └────────────────────────────────────────────────────────────┘   │
│         │                                                            │
│         ▼                                                            │
│  Step 3: EXECUTION                                                  │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ MCP Tool Execution                                           │   │
│  │ ┌──────────────────────────────────────────────────────┐   │   │
│  │ │ LangChain StructuredTool                              │   │   │
│  │ │   └─> MCPToolWrapper (adds user context)             │   │   │
│  │ │        └─> FastMCP FunctionTool                       │   │   │
│  │ │             └─> Actual MCP function                   │   │   │
│  │ │                  └─> Database/Redis operations        │   │   │
│  │ └──────────────────────────────────────────────────────┘   │   │
│  │ Result: {families: [{id: "123", name: "Smith Family"}]} │   │   │
│  └────────────────────────────────────────────────────────────┘   │
│         │                                                            │
│         ▼                                                            │
│  Step 4: OBSERVATION                                                │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ LLM (Ollama llama3.2:1b)                                     │   │
│  │ Input: Previous reasoning + Tool result                     │   │
│  │ Output: Analysis of result                                  │   │
│  │         Decision to continue or respond                     │   │
│  └────────────────────────────────────────────────────────────┘   │
│         │                                                            │
│         ▼                                                            │
│  Step 5: DECISION                                                   │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │ Continue loop? OR Final Answer?                             │   │
│  │                                                              │   │
│  │ IF need more info → Go back to Step 1                       │   │
│  │ IF have answer → Generate final response                    │   │
│  └────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    RESPONSE HANDLING                                 │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ 1. Extract final AI message                                  │  │
│  │ 2. Add user message to Redis history                         │  │
│  │ 3. Add AI response to Redis history                          │  │
│  │ 4. Trim history if > 50 messages                             │  │
│  │ 5. Return response to user                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    OBSERVABILITY (Optional)                          │
│  LangSmith Tracing - if LANGCHAIN_TRACING_V2=true                   │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ • Full execution trace                                        │  │
│  │ • LLM calls with prompts and responses                       │  │
│  │ • Tool executions with inputs/outputs                        │  │
│  │ • Performance metrics (latency, tokens)                      │  │
│  │ • Error tracking and debugging info                          │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## Tool Access Control Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                    User Authentication                               │
│  JWT Token → MCPUserContext                                         │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ user_id: "user_123"                                           │  │
│  │ username: "john"                                              │  │
│  │ role: "admin"                                                 │  │
│  │ permissions: ["admin", "family:read", "shop:write", ...]     │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              Tool Creation (orchestrator._create_tools_for_user)    │
│                                                                      │
│  IF MCP_FAMILY_TOOLS_ENABLED:                                       │
│    ✅ Add family tools (get_family_info, etc.)                      │
│                                                                      │
│  IF MCP_SHOP_TOOLS_ENABLED:                                         │
│    ✅ Add shop tools (get_featured_items, get_owned_avatars, etc.)  │
│                                                                      │
│  IF MCP_AUTH_TOOLS_ENABLED:                                         │
│    ✅ Add auth tools (get_security_dashboard, etc.)                 │
│                                                                      │
│  IF MCP_WORKSPACE_TOOLS_ENABLED:                                    │
│    ✅ Add workspace tools (create_workspace, etc.)                  │
│                                                                      │
│  IF MCP_ADMIN_TOOLS_ENABLED AND user has admin permission:          │
│    ✅ Add admin tools (get_system_metrics, etc.)                    │
│  ELSE:                                                               │
│    ❌ Skip admin tools                                              │
│                                                                      │
│  Result: List of 33 tools (for admin) or fewer (for regular users) │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Agent Creation                                    │
│  create_react_agent(llm, tools, prompt)                             │
│  • Agent only has access to tools created above                     │
│  • Cannot access tools not in the list                              │
│  • User context embedded in each tool wrapper                       │
└─────────────────────────────────────────────────────────────────────┘
```

## Memory Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Redis Storage                                │
│                                                                      │
│  Key Pattern: chat_history:{session_id}                            │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ Session: user_123_session_456                                 │  │
│  │ TTL: 3600 seconds (1 hour)                                    │  │
│  │                                                                │  │
│  │ Messages (JSON array):                                        │  │
│  │ [                                                              │  │
│  │   {                                                            │  │
│  │     "type": "human",                                           │  │
│  │     "content": "What families am I in?",                       │  │
│  │     "timestamp": "2025-11-02T12:00:00Z"                       │  │
│  │   },                                                           │  │
│  │   {                                                            │  │
│  │     "type": "ai",                                              │  │
│  │     "content": "You are in 1 family: Smith Family",           │  │
│  │     "timestamp": "2025-11-02T12:00:02Z"                       │  │
│  │   },                                                           │  │
│  │   {                                                            │  │
│  │     "type": "human",                                           │  │
│  │     "content": "Show me avatars",                             │  │
│  │     "timestamp": "2025-11-02T12:01:00Z"                       │  │
│  │   },                                                           │  │
│  │   {                                                            │  │
│  │     "type": "ai",                                              │  │
│  │     "content": "You own 3 avatars: ...",                      │  │
│  │     "timestamp": "2025-11-02T12:01:03Z"                       │  │
│  │   }                                                            │  │
│  │ ]                                                              │  │
│  │                                                                │  │
│  │ Auto-trimmed to max 50 messages                               │  │
│  │ Expires after 1 hour of inactivity                            │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

## Tool Execution Detail

```
┌─────────────────────────────────────────────────────────────────────┐
│           Agent decides to call: get_family_info                     │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  LangChain StructuredTool                            │
│  Name: "get_family_info"                                            │
│  Description: "Get detailed information about a family"             │
│  Parameters: {family_id: string}                                    │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     MCPToolWrapper                                   │
│  • Wraps the MCP function                                           │
│  • Injects user_context from closure                                │
│  • Handles async execution                                          │
│  • Catches and formats errors                                       │
│                                                                      │
│  async def execute(family_id: str):                                 │
│      # Set user context in thread local                             │
│      set_mcp_user_context(self.user_context)                        │
│                                                                      │
│      # Call actual MCP function                                     │
│      result = await self.mcp_function(family_id)                    │
│                                                                      │
│      # Clear context                                                │
│      clear_mcp_user_context()                                       │
│                                                                      │
│      return result                                                  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│              FastMCP @authenticated_tool Function                    │
│  @authenticated_tool(                                               │
│      name="get_family_info",                                        │
│      permissions=["family:read"],                                   │
│      rate_limit_action="family_read"                                │
│  )                                                                   │
│  async def get_family_info(family_id: str):                         │
│      # Get user context from thread local                           │
│      user_context = get_mcp_user_context()                          │
│                                                                      │
│      # Check permissions                                            │
│      if not user_context.has_permission("family:read"):             │
│          raise MCPAuthorizationError("No permission")               │
│                                                                      │
│      # Rate limit check                                             │
│      await check_rate_limit(user_context, "family_read")            │
│                                                                      │
│      # Execute business logic                                       │
│      family_data = await family_manager.get_family(family_id)       │
│                                                                      │
│      # Audit logging                                                │
│      await create_audit_trail(...)                                  │
│                                                                      │
│      return family_data                                             │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Database Operations                               │
│  MongoDB: Read family document                                      │
│  Redis: Check cache, rate limits                                    │
│  Returns: {id: "123", name: "Smith Family", ...}                   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    Result bubbles back up                            │
│  Database → MCP Function → Wrapper → Tool → Agent → User            │
└─────────────────────────────────────────────────────────────────────┘
```

## Complete Request Example

```
┌──────────────────────────────────────────────────────────────────┐
│ USER: "What families am I in and show me my avatars"             │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ FastAPI: POST /api/v1/ai/chat                                    │
│ Headers: Authorization: Bearer <jwt_token>                       │
│ Body: {                                                          │
│   "message": "What families am I in and show me my avatars",    │
│   "session_id": "session_123"                                    │
│ }                                                                 │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ LangChainOrchestrator.chat()                                     │
│                                                                   │
│ Step 1: Get agent for user                                       │
│   - Create/retrieve cached agent with 33 tools                   │
│                                                                   │
│ Step 2: Load conversation history from Redis                     │
│   - Key: chat_history:session_123                                │
│   - Previous 5 messages loaded                                   │
│                                                                   │
│ Step 3: Agent execution (LangGraph ReAct)                        │
│                                                                   │
│   Iteration 1:                                                   │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │ LLM: Think                                                │  │
│   │ "I need to check families first"                          │  │
│   │                                                            │  │
│   │ LLM: Act                                                   │  │
│   │ Tool: get_family_info                                     │  │
│   │ Result: {families: [{name: "Smith Family"}, ...]}        │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                   │
│   Iteration 2:                                                   │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │ LLM: Think                                                │  │
│   │ "Now I need to get avatars"                               │  │
│   │                                                            │  │
│   │ LLM: Act                                                   │  │
│   │ Tool: get_owned_avatars                                   │  │
│   │ Result: {avatars: [{name: "Cat Avatar"}, ...]}           │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                   │
│   Iteration 3:                                                   │
│   ┌──────────────────────────────────────────────────────────┐  │
│   │ LLM: Think                                                │  │
│   │ "I have all information needed"                           │  │
│   │                                                            │  │
│   │ LLM: Final Answer                                         │  │
│   │ "You are in 1 family (Smith Family) and you own 3        │  │
│   │  avatars: Cat Avatar, Dog Avatar, and Robot Avatar."     │  │
│   └──────────────────────────────────────────────────────────┘  │
│                                                                   │
│ Step 4: Save to Redis history                                    │
│   - Add user message                                             │
│   - Add AI response                                              │
│   - Trim to 50 messages                                          │
│                                                                   │
│ Step 5: Return response                                          │
└─────────────────────────────┬────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ Response to User:                                                │
│ {                                                                 │
│   "response": "You are in 1 family (Smith Family) and you own   │
│                3 avatars: Cat Avatar, Dog Avatar, and Robot      │
│                Avatar.",                                         │
│   "session_id": "session_123"                                    │
│ }                                                                 │
└──────────────────────────────────────────────────────────────────┘
```

## LangSmith Trace Example

When `LANGCHAIN_TRACING_V2=true`:

```
smith.langchain.com/SecondBrainDatabase

Run: "What families am I in and show me my avatars"
├─ Duration: 1.24s
├─ Tokens: 456 (input: 234, output: 222)
├─ Cost: $0.00 (local model)
│
├─ Step 1: Agent Start
│  └─ Input: "What families am I in and show me my avatars"
│  
├─ Step 2: LLM Call #1 (llama3.2:1b)
│  ├─ Prompt Tokens: 145
│  ├─ Completion Tokens: 32
│  ├─ Latency: 234ms
│  └─ Output: Thought + Action(get_family_info)
│  
├─ Step 3: Tool Execution - get_family_info
│  ├─ Input: {}
│  ├─ Latency: 42ms
│  └─ Output: {families: [...]}
│  
├─ Step 4: LLM Call #2 (llama3.2:1b)
│  ├─ Prompt Tokens: 198
│  ├─ Completion Tokens: 35
│  ├─ Latency: 256ms
│  └─ Output: Thought + Action(get_owned_avatars)
│  
├─ Step 5: Tool Execution - get_owned_avatars
│  ├─ Input: {}
│  ├─ Latency: 38ms
│  └─ Output: {avatars: [...]}
│  
├─ Step 6: LLM Call #3 (llama3.2:1b)
│  ├─ Prompt Tokens: 287
│  ├─ Completion Tokens: 155
│  ├─ Latency: 412ms
│  └─ Output: Final answer
│  
└─ Step 7: Agent End
   └─ Output: "You are in 1 family (Smith Family) and you own 3 avatars..."
```

## System Dependencies

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Infrastructure                               │
│                                                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │   MongoDB    │  │    Redis     │  │    Ollama    │             │
│  │              │  │              │  │              │             │
│  │ User data    │  │ Chat history │  │ llama3.2:1b  │             │
│  │ Families     │  │ Rate limits  │  │              │             │
│  │ Shop items   │  │ Caching      │  │ Port: 11434  │             │
│  └──────────────┘  └──────────────┘  └──────────────┘             │
│         ▲                 ▲                  ▲                       │
│         │                 │                  │                       │
│         └─────────────────┴──────────────────┘                       │
│                           │                                          │
└───────────────────────────┼──────────────────────────────────────────┘
                            │
┌───────────────────────────┼──────────────────────────────────────────┐
│                 Second Brain Database (FastAPI)                      │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ LangChain Integration Layer                                   │  │
│  │                                                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │  │
│  │  │Orchestrator │  │   Memory    │  │    Tools    │          │  │
│  │  │             │  │             │  │             │          │  │
│  │  │ Agent Mgmt  │  │ Redis Store │  │ MCP Wrapper │          │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘          │  │
│  │                                                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ FastMCP Server                                                │  │
│  │                                                                │  │
│  │  53 MCP Tools (Family, Shop, Auth, Workspace, Admin)         │  │
│  │  - Authentication & authorization                             │  │
│  │  - Rate limiting                                              │  │
│  │  - Audit logging                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└───────────────────────────────┬──────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    External Services (Optional)                      │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ LangSmith (smith.langchain.com)                               │  │
│  │                                                                │  │
│  │ - Execution tracing                                           │  │
│  │ - Performance metrics                                         │  │
│  │ - Debugging & monitoring                                      │  │
│  │ - Dataset management                                          │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

**Last Updated:** 2 November 2025  
**Version:** 1.0.0
