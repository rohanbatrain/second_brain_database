"""
Workspace MCP Resources

Comprehensive information resources for workspace entities with access control.
Provides workspace information, member lists, and analytics through MCP resources.
"""

import json
from typing import Dict, Any, List, Optional
from datetime import datetime

from ....managers.workspace_manager import WorkspaceManager
from ....managers.logging_manager import get_logger
from ....config import settings
from ..modern_server import mcp
from ..security import get_mcp_user_context
from ..context import require_workspace_access, create_mcp_audit_trail
from ..exceptions import MCPAuthorizationError, MCPValidationError

logger = get_logger(prefix="[MCP_WorkspaceResources]")

# Import manager instances
from ....database import db_manager
from ....managers.security_manager import security_manager
from ....managers.redis_manager import redis_manager

@mcp.resource("workspace://{workspace_id}/info", tags={"production", "resources", "secure", "workspace"})
    async def get_workspace_info_resource(workspace_id: str) -> str:
        """
        Get comprehensive workspace information as a resource.
        
        Provides detailed workspace information including basic details,
        member count, wallet status, and configuration settings.
        
        Args:
            workspace_id: The ID of the workspace to get information for
            
        Returns:
            JSON string containing workspace information
        """
        try:
            user_context = get_mcp_user_context()
            
            # Validate workspace access
            await require_workspace_access(workspace_id, user_context=user_context)
            
            # Create workspace manager instance
            workspace_manager = WorkspaceManager(
                db_manager=db_manager,
                security_manager=security_manager,
                redis_manager=redis_manager
            )
            
            # Get workspace details
            workspace_details = await workspace_manager.get_workspace_details(workspace_id, user_context.user_id)
            
            # Get workspace wallet information
            wallet_info = await workspace_manager.get_workspace_wallet(workspace_id, user_context.user_id)
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_workspace_info_resource",
                user_context=user_context,
                resource_type="workspace",
                resource_id=workspace_id,
                metadata={"resource_type": "workspace_info"}
            )
            
            # Combine information
            workspace_info = {
                "id": workspace_id,
                "name": workspace_details.get("name"),
                "description": workspace_details.get("description"),
                "created_at": workspace_details.get("created_at").isoformat() if workspace_details.get("created_at") else None,
                "member_count": workspace_details.get("member_count", 0),
                "owner_id": workspace_details.get("owner_id"),
                "wallet": {
                    "balance": wallet_info.get("balance", 0),
                    "frozen": wallet_info.get("frozen", False),
                    "pending_requests": wallet_info.get("pending_requests", 0)
                },
                "limits": workspace_details.get("limits", {}),
                "settings": workspace_details.get("settings", {}),
                "last_updated": datetime.utcnow().isoformat()
            }
            
            logger.info("Provided workspace info resource for workspace %s to user %s", 
                       workspace_id, user_context.user_id)
            
            return json.dumps(workspace_info, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get workspace info resource for %s: %s", workspace_id, e)
            return json.dumps({"error": f"Failed to retrieve workspace information: {str(e)}"}, indent=2)


        @mcp.resource("workspace://{workspace_id}/members", tags={"production", "resources", "secure", "workspace"})
    async def get_workspace_members_resource(workspace_id: str) -> str:
        """
        Get workspace member list as a resource with access control.
        
        Provides comprehensive member information including roles
        and permissions for authorized users.
        
        Args:
            workspace_id: The ID of the workspace to get members for
            
        Returns:
            JSON string containing workspace member list
        """
        try:
            user_context = get_mcp_user_context()
            
            # Validate workspace access
            await require_workspace_access(workspace_id, user_context=user_context)
            
            workspace_manager = WorkspaceManager(
                db_manager=db_manager,
                security_manager=security_manager,
                redis_manager=redis_manager
            )
            
            # Get workspace members
            members = await workspace_manager.get_workspace_members(workspace_id, user_context.user_id)
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_workspace_members_resource",
                user_context=user_context,
                resource_type="workspace",
                resource_id=workspace_id,
                metadata={"resource_type": "workspace_members", "member_count": len(members)}
            )
            
            # Format member information
            member_list = []
            for member in members:
                member_info = {
                    "user_id": member.get("user_id"),
                    "username": member.get("username"),
                    "email": member.get("email") if user_context.get_workspace_role(workspace_id) in ["admin", "owner"] else None,
                    "role": member.get("role"),
                    "joined_at": member.get("joined_at").isoformat() if member.get("joined_at") else None,
                    "permissions": member.get("permissions", {}),
                    "last_active": member.get("last_active").isoformat() if member.get("last_active") else None
                }
                member_list.append(member_info)
            
            result = {
                "workspace_id": workspace_id,
                "members": member_list,
                "total_members": len(member_list),
                "last_updated": datetime.utcnow().isoformat()
            }
            
            logger.info("Provided workspace members resource for workspace %s to user %s (%d members)", 
                       workspace_id, user_context.user_id, len(member_list))
            
            return json.dumps(result, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get workspace members resource for %s: %s", workspace_id, e)
            return json.dumps({"error": f"Failed to retrieve workspace members: {str(e)}"}, indent=2)


        @mcp.resource("workspace://{workspace_id}/analytics", tags={"production", "resources", "secure", "workspace"})
    async def get_workspace_analytics_resource(workspace_id: str) -> str:
        """
        Get workspace analytics and usage data as a resource.
        
        Provides comprehensive workspace usage statistics, activity metrics,
        and financial information for analytics purposes.
        
        Args:
            workspace_id: The ID of the workspace to get analytics for
            
        Returns:
            JSON string containing workspace analytics
        """
        try:
            user_context = get_mcp_user_context()
            
            # Validate workspace access (admin required for detailed analytics)
            await require_workspace_access(workspace_id, required_role="admin", user_context=user_context)
            
            workspace_manager = WorkspaceManager(
                db_manager=db_manager,
                security_manager=security_manager,
                redis_manager=redis_manager
            )
            
            # Get workspace analytics
            workspace_stats = await workspace_manager.get_workspace_analytics(workspace_id, user_context.user_id)
            
            # Get wallet analytics
            wallet_stats = await workspace_manager.get_workspace_wallet_analytics(workspace_id, user_context.user_id)
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_workspace_analytics_resource",
                user_context=user_context,
                resource_type="workspace",
                resource_id=workspace_id,
                metadata={"resource_type": "workspace_analytics"}
            )
            
            # Compile comprehensive analytics
            analytics = {
                "workspace_id": workspace_id,
                "overview": {
                    "total_members": workspace_stats.get("member_count", 0),
                    "active_members_30d": workspace_stats.get("active_members_30d", 0),
                    "creation_date": workspace_stats.get("created_at").isoformat() if workspace_stats.get("created_at") else None,
                    "days_active": workspace_stats.get("days_active", 0)
                },
                "activity": {
                    "total_invitations_sent": workspace_stats.get("invitations_sent", 0),
                    "successful_invitations": workspace_stats.get("successful_invitations", 0),
                    "pending_invitations": workspace_stats.get("pending_invitations", 0),
                    "member_joins_30d": workspace_stats.get("member_joins_30d", 0),
                    "admin_actions_30d": workspace_stats.get("admin_actions_30d", 0)
                },
                "financial": {
                    "wallet_balance": wallet_stats.get("current_balance", 0),
                    "total_received": wallet_stats.get("total_received", 0),
                    "total_spent": wallet_stats.get("total_spent", 0),
                    "pending_requests": wallet_stats.get("pending_requests", 0),
                    "approved_requests_30d": wallet_stats.get("approved_requests_30d", 0),
                    "spending_by_category": wallet_stats.get("spending_by_category", {})
                },
                "permissions": {
                    "members_with_wallet_access": workspace_stats.get("members_with_wallet_permissions", 0),
                    "admin_count": workspace_stats.get("admin_count", 0),
                    "backup_admins": workspace_stats.get("backup_admin_count", 0)
                },
                "generated_at": datetime.utcnow().isoformat()
            }
            
            logger.info("Provided workspace analytics resource for workspace %s to user %s", 
                       workspace_id, user_context.user_id)
            
            return json.dumps(analytics, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get workspace analytics resource for %s: %s", workspace_id, e)
            return json.dumps({"error": f"Failed to retrieve workspace analytics: {str(e)}"}, indent=2)

        else:
        logger.warning("FastMCP not available - workspace resources will not be registered")