# LangGraph Platform API Integration

This document provides a quick reference for the LangGraph Platform API implementation in Second Brain Database, making it compatible with AgentChat UI and other LangGraph-compatible clients.

## Overview

The LangGraph Platform API enables:
- **Thread Management**: Create and manage conversation threads
- **Streaming Execution**: Real-time agent responses via Server-Sent Events (SSE)
- **Checkpointing**: Persistent conversation state in Redis
- **Multiple Agents**: Specialized agents for different domains (family, shop, workspace)
- **Tool Integration**: Seamless access to FastMCP tools with permission-based filtering

## Quick Start

### 1. Prerequisites

Ensure you have:
- Redis running on `localhost:6379`
- MongoDB running on `localhost:27017`
- Python 3.11+
- Dependencies installed: `pip install -r requirements.txt`

### 2. Configuration

The `.sbd` file contains LangGraph settings:

```ini
# LangGraph Platform API Settings
LANGGRAPH_ENABLED=true
LANGGRAPH_API_URL=http://localhost:8000/api/v1
LANGGRAPH_CHECKPOINTER=redis
LANGGRAPH_DEFAULT_GRAPH=sbd_agent
LANGGRAPH_CHECKPOINT_TTL=86400
```

### 3. Start the Server

```bash
# Start Redis and MongoDB (if using Docker)
docker-compose up -d redis mongodb

# Start the FastAPI server
uvicorn src.second_brain_database.main:app --reload --port 8000
```

### 4. Test the API

```bash
# Run validation script
python test_langgraph_platform.py
```

## API Endpoints

### Base URL
```
http://localhost:8000/api/v1
```

### Threads

**Create Thread**
```bash
curl -X POST http://localhost:8000/api/v1/threads \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"metadata": {"name": "My Conversation"}}'
```

**Get Thread**
```bash
curl http://localhost:8000/api/v1/threads/{thread_id} \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**List Threads**
```bash
curl http://localhost:8000/api/v1/threads \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Delete Thread**
```bash
curl -X DELETE http://localhost:8000/api/v1/threads/{thread_id} \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Runs

**Create Run (Streaming)**
```bash
curl -X POST http://localhost:8000/api/v1/threads/{thread_id}/runs \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "assistant_id": "sbd_agent",
    "input": {
      "messages": [
        {"role": "user", "content": "Hello!"}
      ]
    },
    "stream": true
  }'
```

**Get Run Status**
```bash
curl http://localhost:8000/api/v1/threads/{thread_id}/runs/{run_id} \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Assistants

**List Assistants**
```bash
curl http://localhost:8000/api/v1/assistants \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**Get Assistant**
```bash
curl http://localhost:8000/api/v1/assistants/sbd_agent \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## Available Agents

### 1. **sbd_agent** (General Purpose)
- **Description**: Full-featured agent with access to all tools
- **Capabilities**: Family management, shopping, workspace operations, admin tasks
- **Tools**: family, shop, workspace, admin
- **Use Case**: General assistance and multi-domain tasks

### 2. **family_agent** (Family Management)
- **Description**: Specialized for family account operations
- **Capabilities**: Create families, manage invitations, configure permissions
- **Tools**: family
- **Use Case**: Family account setup and management

### 3. **shop_agent** (E-Commerce)
- **Description**: Specialized for shopping operations
- **Capabilities**: Product search, cart management, order processing
- **Tools**: shop
- **Use Case**: Shopping assistance and recommendations

### 4. **workspace_agent** (Productivity)
- **Description**: Specialized for workspace operations
- **Capabilities**: Document management, collaboration, task tracking
- **Tools**: workspace
- **Use Case**: Workspace organization and productivity

## AgentChat UI Integration

### Setup

1. **Clone AgentChat UI**
   ```bash
   git clone https://github.com/langchain-ai/agentchat-ui
   cd agentchat-ui
   ```

2. **Configure Environment**
   ```bash
   # .env.local
   NEXT_PUBLIC_LANGGRAPH_API_URL=http://localhost:8000/api/v1
   ```

3. **Start AgentChat UI**
   ```bash
   npm install
   npm run dev
   ```

4. **Open in Browser**
   ```
   http://localhost:3000
   ```

### Authentication

AgentChat UI will need to pass the JWT token. You can:

1. **Option A**: Modify AgentChat UI to include the token
   - Add `Authorization: Bearer TOKEN` header to API calls

2. **Option B**: Use a proxy with authentication
   - Set up nginx or similar to add the auth header

## Architecture

### Components

```
┌─────────────────────────────────────────┐
│         AgentChat UI (Frontend)         │
│         http://localhost:3000           │
└─────────────────┬───────────────────────┘
                  │ HTTP/SSE
                  ▼
┌─────────────────────────────────────────┐
│    LangGraph Platform API (FastAPI)    │
│      http://localhost:8000/api/v1      │
├─────────────────────────────────────────┤
│  • /threads      (Thread Management)    │
│  • /runs         (Streaming Execution)  │
│  • /assistants   (Agent Listing)        │
└──────────┬──────────────────────────────┘
           │
           ├──────────────┬──────────────┐
           ▼              ▼              ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │  Redis   │   │ LangGraph│   │ FastMCP  │
    │Checkpoint│   │  Graphs  │   │  Tools   │
    └──────────┘   └──────────┘   └──────────┘
```

### Data Flow

1. **User Message** → AgentChat UI
2. **API Request** → POST /threads/{id}/runs
3. **Graph Execution** → StateGraph with tools
4. **Streaming Events** → SSE back to client
5. **Checkpoint** → Save state to Redis
6. **Tool Calls** → Execute via FastMCP
7. **Response** → Stream to AgentChat UI

## Checkpointing

### How It Works

1. **State Persistence**: Every graph execution saves state to Redis
2. **Thread Continuity**: Resume conversations from any checkpoint
3. **TTL Management**: Checkpoints expire after 24 hours (configurable)
4. **Key Format**: `langgraph:checkpoint:{thread_id}:{checkpoint_id}`

### Redis Keys

```bash
# View all checkpoints
redis-cli KEYS "langgraph:checkpoint:*"

# View specific thread checkpoints
redis-cli KEYS "langgraph:checkpoint:{thread_id}:*"

# View threads
redis-cli KEYS "thread:*"

# View runs
redis-cli KEYS "run:*"
```

## Monitoring

### LangSmith Integration

All agent executions are traced to LangSmith:

```ini
LANGCHAIN_TRACING_V2=true
LANGCHAIN_API_KEY=your_langsmith_key
LANGCHAIN_PROJECT=SecondBrainDatabase
```

View traces at: https://smith.langchain.com/

### Metrics

Prometheus metrics available at:
```
http://localhost:8000/metrics
```

### Logs

Application logs include:
- Thread creation/deletion
- Run execution
- Tool calls
- Checkpoint operations
- Errors and warnings

## Development

### Adding a New Agent

1. **Update `assistants.py`**:
   ```python
   ASSISTANTS["my_agent"] = Assistant(
       id="my_agent",
       name="My Custom Agent",
       description="Agent description",
       graph_id="sbd_agent",  # Or create new graph
       metadata={"tools": ["my_tools"]},
       ...
   )
   ```

2. **Update `langgraph.json`** (if new graph):
   ```json
   {
     "graphs": {
       "my_agent": "path.to.graph:graph"
     }
   }
   ```

3. **Test**:
   ```bash
   curl http://localhost:8000/api/v1/assistants/my_agent
   ```

### Creating a Custom Graph

See `src/second_brain_database/integrations/langgraph/graphs/sbd_agent.py` for reference:

```python
from langgraph.graph import StateGraph, MessagesState

def create_my_graph():
    graph = StateGraph(MessagesState)
    graph.add_node("agent", call_model)
    graph.add_node("tools", tool_node)
    graph.add_conditional_edges("agent", should_continue)
    graph.add_edge("tools", "agent")
    graph.set_entry_point("agent")
    return graph
```

## Troubleshooting

### Common Issues

**1. Connection Refused**
```bash
# Check if server is running
curl http://localhost:8000/health

# Check if Redis is running
redis-cli ping
```

**2. Authentication Errors**
```bash
# Verify token
curl http://localhost:8000/auth/verify \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**3. Checkpoints Not Persisting**
```bash
# Check Redis connection
redis-cli KEYS "langgraph:*"

# Verify TTL
redis-cli TTL "thread:{thread_id}"
```

**4. Tools Not Available**
- Check user permissions
- Verify FastMCP server is running
- Check tool filtering in graph initialization

### Debug Mode

Enable detailed logging:
```ini
DEBUG=true
LANGCHAIN_TRACING_V2=true
```

## Performance

### Optimization Tips

1. **Checkpoint TTL**: Adjust based on usage patterns
   ```ini
   LANGGRAPH_CHECKPOINT_TTL=86400  # 24 hours
   ```

2. **Redis Connection Pool**: Configure in Redis settings
3. **Streaming Chunk Size**: Adjust in `runs.py` event generator
4. **Concurrent Runs**: Monitor Redis performance

### Benchmarks

Typical performance:
- Thread creation: ~10ms
- Run execution: ~500-2000ms (depends on tool calls)
- Checkpoint save: ~5ms
- SSE streaming: Real-time (<100ms latency)

## Security

### Authentication
- All endpoints require JWT authentication
- Token validated on every request
- User context passed to tools for permission filtering

### Authorization
- Thread ownership verified
- User permissions checked for tool access
- Admin-only tools restricted

### Data Protection
- Checkpoints include user context
- TTL ensures automatic cleanup
- Redis keys prefixed for isolation

## References

- [LangGraph Documentation](https://langchain-ai.github.io/langgraph/)
- [AgentChat UI](https://github.com/langchain-ai/agentchat-ui)
- [FastMCP Documentation](https://gofastmcp.com/)
- [LangSmith](https://smith.langchain.com/)

## Support

For issues or questions:
1. Check the logs: `logs/second_brain_database.log`
2. Review LangSmith traces
3. Test with `test_langgraph_platform.py`
4. Check implementation status: `docs/LANGGRAPH_IMPLEMENTATION_STATUS.md`
