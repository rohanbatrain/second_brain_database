{% extends "base.html" %}

{% block title %}OAuth2 Test App - Profile{% endblock %}

{% block content %}
<div class="info-box">
    <h3>User Profile</h3>
    {% if user_info.error %}
        <p><span class="status-badge status-error">Error: {{ user_info.error }}</span></p>
        <p>Unable to load user profile. This might indicate an issue with the API or token permissions.</p>
    {% else %}
        <table>
            {% for key, value in user_info.items() %}
            <tr>
                <th>{{ key|title|replace('_', ' ') }}</th>
                <td>
                    {% if value is mapping %}
                        <div class="code">{{ value|tojson(indent=2) }}</div>
                    {% elif value is iterable and value is not string %}
                        {% for item in value %}
                            <span class="status-badge status-success">{{ item }}</span>
                        {% endfor %}
                    {% else %}
                        {{ value }}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </table>
    {% endif %}
</div>

<div class="info-box">
    <h3>Token Status</h3>
    <table>
        <tr>
            <th>Token Type</th>
            <td>{{ token_info.token_type }}</td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if is_expired %}
                    <span class="status-badge status-error">Expired</span>
                {% else %}
                    <span class="status-badge status-success">Valid</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Expires At</th>
            <td>
                {{ token_info.expires_at|int }}
                <br><small>{{ (token_info.expires_at - now())|int }} seconds remaining</small>
            </td>
        </tr>
        <tr>
            <th>Granted Scopes</th>
            <td>
                {% for scope in token_info.scope %}
                    <span class="status-badge status-success">{{ scope }}</span>
                {% endfor %}
            </td>
        </tr>
    </table>
    
    {% if (token_info.expires_at - now()) < 300 %}
        <p><span class="status-badge status-warning">âš  Token expires in less than 5 minutes</span></p>
        <p><a href="{{ url_for('refresh_token') }}" style="display: inline-block; padding: 8px 16px; background: #ffc107; color: #212529; text-decoration: none; border-radius: 4px;">ðŸ”„ Refresh Token</a></p>
    {% endif %}
</div>

<div class="info-box">
    <h3>API Testing</h3>
    <p>Test your OAuth2 token with various API endpoints:</p>
    
    <div style="margin-bottom: 15px;">
        <a href="{{ url_for('api_test') }}" target="_blank" style="display: inline-block; padding: 8px 16px; background: #17a2b8; color: white; text-decoration: none; border-radius: 4px;">ðŸ§ª Run API Tests</a>
    </div>
    
    <p><strong>Available Test Endpoints:</strong></p>
    <ul>
        <li><code>GET /api/user/profile</code> - Fetch user profile information</li>
        <li><code>GET /api/health</code> - Check API health status</li>
    </ul>
    
    <p><small>API tests will open in a new tab and return JSON responses.</small></p>
</div>

<div class="info-box">
    <h3>Token Management</h3>
    <p>Manage your OAuth2 tokens:</p>
    
    <div style="margin-bottom: 10px;">
        <a href="{{ url_for('refresh_token') }}" style="display: inline-block; padding: 8px 16px; background: #28a745; color: white; text-decoration: none; border-radius: 4px; margin-right: 10px;">ðŸ”„ Refresh Token</a>
        <a href="{{ url_for('logout') }}" style="display: inline-block; padding: 8px 16px; background: #dc3545; color: white; text-decoration: none; border-radius: 4px;">ðŸšª Logout & Revoke</a>
    </div>
    
    <p><small>
        <strong>Refresh Token:</strong> Get a new access token using your refresh token.<br>
        <strong>Logout:</strong> Revoke all tokens and clear your session.
    </small></p>
</div>

<div class="info-box">
    <h3>Debug Information</h3>
    <p>Current session state for debugging:</p>
    
    <div class="code">
Session Keys: {{ session.keys()|list|join(', ') }}
Token Info: {{ token_info|tojson(indent=2) if token_info else 'None' }}
User Info Keys: {{ user_info.keys()|list|join(', ') if user_info and not user_info.error else 'Error or None' }}
    </div>
</div>
{% endblock %}