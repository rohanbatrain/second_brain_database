# Notification "From" field — Flutter guidance

This note explains a recent backend change that guarantees a canonical "From" value for family token requests and related notifications, and shows the minimal changes the Flutter app should make so the Token Requests UI always displays a sensible "From:" value.

## What changed on the server
- New canonical fields were added to notifications and token-request responses:
  - Notifications (collection `family_notifications`) now include `data.from_user_id` and `data.from_username` for all new notifications generated by the family manager helpers.
  - The token-requests pending endpoint (`GET /family/{family_id}/token-requests/pending`) now returns `from_user_id` and `from_username` on each `TokenRequestResponse`.

These are populated for new requests/notifications created after the change; older documents created before the change may be missing them.

## Goal for the Flutter app
Always show a human-friendly "From:" string on token-request cards. Use a small, safe prioritised lookup so older records (or notification-only flows) continue to work.

Preferred fallback order (server-backed → graceful fallback):
1. response.from_username (the canonical field added to the pending token-requests response)
2. notification.data.from_username (if your UI is rendering notification documents directly)
3. response.requester_username (existing field available before the change)
4. a localized fallback string such as `"Family Account"` or `"Unknown"`

## Example JSON the Flutter app will receive from the pending endpoint

```json
[
  {
    "request_id": "req_9f063d76360d4eb7",
    "requester_username": "rohan",
    "from_user_id": "68f3c68604839468a2f226f0",
    "from_username": "rohan",
    "amount": 200,
    "reason": "tryyhyy",
    "status": "pending",
    "auto_approved": false,
    "created_at": "2025-10-23T13:33:56.635084+00:00",
    "expires_at": "2025-10-30T13:33:56.635084+00:00",
    "admin_comments": null
  }
]
```

And a notification document example (stored in `family_notifications`) for reference:

```json
{
  "notification_id": "not_f4883b2883594a29",
  "family_id": "fam_32978f981bc246e5",
  "type": "token_request_created",
  "data": {
    "request_id": "req_9f063d76360d4eb7",
    "requester_user_id": "68f3c68604839468a2f226f0",
    "requester_username": "rohan",
    "from_user_id": "68f3c68604839468a2f226f0",
    "from_username": "rohan",
    "amount": 200,
    "reason": "tryyhyy"
  }
}
```

## Minimal Flutter/Dart changes

1. Update the token request model to include optional `fromUserId` and `fromUsername` fields.
2. When rendering the card, compute the displayed `from` value once using the fallback order.

Example Dart model (json_serializable / manual parsing):

```dart
class TokenRequest {
  final String requestId;
  final String requesterUsername;
  final String? fromUserId;
  final String? fromUsername;
  // other fields omitted

  TokenRequest({
    required this.requestId,
    required this.requesterUsername,
    this.fromUserId,
    this.fromUsername,
  });

  factory TokenRequest.fromJson(Map<String, dynamic> json) => TokenRequest(
    requestId: json['request_id'] as String,
    requesterUsername: json['requester_username'] as String,
    fromUserId: json['from_user_id'] as String?,
    fromUsername: json['from_username'] as String?,
  );
}
```

Rendering helper (use this to compute the display value):

```dart
String computeFromDisplay({TokenRequest? req, Map<String, dynamic>? notificationData}) {
  // 1: response.from_username
  if (req?.fromUsername != null && req!.fromUsername!.isNotEmpty) return req.fromUsername!;

  // 2: notification.data.from_username (if you have the notification payload available)
  final nd = notificationData;
  if (nd != null) {
    final nFrom = nd['from_username'] as String?;
    if (nFrom != null && nFrom.isNotEmpty) return nFrom;
  }

  // 3: response.requester_username
  if (req != null && req.requesterUsername.isNotEmpty) return req.requesterUsername;

  // 4: localized fallback
  return 'Family Account';
}
```

Use the returned string as the `From:` label in the card widget.

## Example UI change (pseudo-Flutter):

```dart
final tokenReq = TokenRequest.fromJson(json);
final displayedFrom = computeFromDisplay(req: tokenReq, notificationData: maybeNotification['data']);

// In the Widget tree
Text('From:'),
Text(displayedFrom, style: fromStyle),
```

## How to test locally
1. Start the backend dev server (ensure you're on the branch that contains the server change).
2. Create a token request using the mobile app or using curl/postman:

```bash
curl -X POST "http://localhost:8000/family/{family_id}/token-requests" \
  -H "Authorization: Bearer <dev token>" \
  -H "Content-Type: application/json" \
  -d '{"amount":200, "reason":"test"}'
```

3. GET the pending endpoint and confirm `from_username` appears:

```bash
curl "http://localhost:8000/family/{family_id}/token-requests/pending" -H "Authorization: Bearer <dev token>"
```

4. If you want to inspect the notification document, query MongoDB (developer machine):

```bash
python scripts/inspect_notification.py req_9f063d76360d4eb7
```

## Rollout & compatibility notes
- The change is additive and backwards-compatible: older clients will keep seeing `requester_username` as before.
- Update the Flutter client to read `from_username` (and fall back) before releasing to users.
- Optionally backfill server-side `from_*` fields for older notifications; the backend team can provide a dry-run script if you want to apply it.

## Suggested PR text for Flutter repo

Title: Show canonical "From" on Token Requests and Notifications

Body:
- Use `fromUsername` (if present) on token-requests responses and notifications as the primary source for the "From:" label.
- Fallback to `requesterUsername` if `fromUsername` is missing.
- Add tests to verify the fallback behavior for older notification records.

Checklist:
- [ ] Parse `fromUsername` in token request model
- [ ] Render `fromUsername` with fallback in token request card
- [ ] Add unit tests for computeFromDisplay logic
- [ ] Manual end-to-end test against dev server

---
If you want, I can open a PR branch with the exact Dart changes (model + small helper + unit tests) and a short sample widget update. Tell me whether your Flutter project uses `json_serializable` or manual parsing and I'll tailor the code.
