"""
User MCP Resources

Comprehensive information resources for user entities with privacy controls.
Provides user profile information, preferences, and activity statistics.
"""

import json
from typing import Dict, Any, List, Optional
from datetime import datetime

from ....managers.logging_manager import get_logger
from ....config import settings
from ..modern_server import mcp
from ..security import get_mcp_user_context
from ..context import create_mcp_audit_trail
from ..exceptions import MCPAuthorizationError, MCPValidationError

logger = get_logger(prefix="[MCP_UserResources]")

# Import manager instances
from ....database import db_manager
from ....managers.security_manager import security_manager
from ....managers.redis_manager import redis_manager

@mcp.resource("user://{user_id}/profile", tags={"production", "resources", "secure", "user"})
    async def get_user_profile_resource(user_id: str) -> str:
        """
        Get user profile information as a resource with privacy controls.
        
        Provides user profile information with appropriate privacy filtering
        based on the requesting user's relationship to the target user.
        
        Args:
            user_id: The ID of the user to get profile for (optional, defaults to current user)
            
        Returns:
            JSON string containing user profile information
        """
        try:
            user_context = get_mcp_user_context()
            
            # Default to current user if no user_id provided or if user_id is "me"
            target_user_id = user_id if user_id and user_id != "me" else user_context.user_id
            is_own_profile = target_user_id == user_context.user_id
            
            # Get user collection
            users_collection = db_manager.get_collection("users")
            
            # Get user profile
            user_profile = await users_collection.find_one({"_id": target_user_id})
            
            if not user_profile:
                return json.dumps({"error": "User not found"}, indent=2)
            
            # Check if users are in the same family for privacy controls
            families_collection = db_manager.get_collection("families")
            shared_families = await families_collection.find({
                "members.user_id": {"$in": [user_context.user_id, target_user_id]}
            }).to_list(length=None)
            
            has_family_relationship = len(shared_families) > 0
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_user_profile_resource",
                user_context=user_context,
                resource_type="user",
                resource_id=target_user_id,
                metadata={
                    "resource_type": "user_profile",
                    "is_own_profile": is_own_profile,
                    "has_family_relationship": has_family_relationship
                }
            )
            
            # Build profile information with privacy controls
            profile_info = {
                "user_id": target_user_id,
                "username": user_profile.get("username"),
                "created_at": user_profile.get("created_at").isoformat() if user_profile.get("created_at") else None,
                "last_active": user_profile.get("last_active").isoformat() if user_profile.get("last_active") else None,
                "profile": {
                    "display_name": user_profile.get("profile", {}).get("display_name"),
                    "bio": user_profile.get("profile", {}).get("bio") if (is_own_profile or has_family_relationship) else None,
                    "avatar_url": user_profile.get("profile", {}).get("current_avatar_url"),
                    "banner_url": user_profile.get("profile", {}).get("current_banner_url"),
                    "theme": user_profile.get("profile", {}).get("current_theme")
                },
                "statistics": {
                    "family_count": len(user_profile.get("families", [])),
                    "workspace_count": len(user_profile.get("workspaces", [])) if is_own_profile else None,
                    "total_sbd_earned": user_profile.get("sbd_stats", {}).get("total_earned", 0) if is_own_profile else None,
                    "account_age_days": (datetime.utcnow() - user_profile.get("created_at")).days if user_profile.get("created_at") else None
                },
                "privacy": {
                    "is_own_profile": is_own_profile,
                    "has_family_relationship": has_family_relationship,
                    "limited_view": not (is_own_profile or has_family_relationship)
                },
                "last_updated": datetime.utcnow().isoformat()
            }
            
            # Add sensitive information only for own profile
            if is_own_profile:
                profile_info["account"] = {
                    "email": user_profile.get("email"),
                    "email_verified": user_profile.get("email_verified", False),
                    "two_factor_enabled": user_profile.get("two_factor", {}).get("enabled", False),
                    "security_lockdown": {
                        "ip_lockdown_enabled": user_profile.get("security", {}).get("ip_lockdown", {}).get("enabled", False),
                        "user_agent_lockdown_enabled": user_profile.get("security", {}).get("user_agent_lockdown", {}).get("enabled", False)
                    }
                }
            
            logger.info("Provided user profile resource for user %s to user %s (own: %s, family: %s)", 
                       target_user_id, user_context.user_id, is_own_profile, has_family_relationship)
            
            return json.dumps(profile_info, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get user profile resource for %s: %s", user_id, e)
            return json.dumps({"error": f"Failed to retrieve user profile: {str(e)}"}, indent=2)


        @mcp.resource("user://{user_id}/preferences", tags={"production", "resources", "secure", "user"})
    async def get_user_preferences_resource(user_id: str) -> str:
        """
        Get user preferences and settings as a resource.
        
        Provides user preferences and configuration settings.
        Only accessible by the user themselves for privacy.
        
        Args:
            user_id: The ID of the user to get preferences for
            
        Returns:
            JSON string containing user preferences
        """
        try:
            user_context = get_mcp_user_context()
            
            # Default to current user if user_id is "me"
            target_user_id = user_id if user_id != "me" else user_context.user_id
            
            # Only allow access to own preferences
            if target_user_id != user_context.user_id:
                return json.dumps({"error": "Access denied - can only view own preferences"}, indent=2)
            
            # Get user collection
            users_collection = db_manager.get_collection("users")
            
            # Get user preferences
            user_data = await users_collection.find_one(
                {"_id": target_user_id},
                {"preferences": 1, "notification_preferences": 1, "privacy_settings": 1}
            )
            
            if not user_data:
                return json.dumps({"error": "User not found"}, indent=2)
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_user_preferences_resource",
                user_context=user_context,
                resource_type="user",
                resource_id=target_user_id,
                metadata={"resource_type": "user_preferences"}
            )
            
            # Build preferences information
            preferences = {
                "user_id": target_user_id,
                "preferences": user_data.get("preferences", {}),
                "notifications": user_data.get("notification_preferences", {}),
                "privacy": user_data.get("privacy_settings", {}),
                "last_updated": datetime.utcnow().isoformat()
            }
            
            logger.info("Provided user preferences resource for user %s", target_user_id)
            
            return json.dumps(preferences, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get user preferences resource for %s: %s", user_id, e)
            return json.dumps({"error": f"Failed to retrieve user preferences: {str(e)}"}, indent=2)


        @mcp.resource("user://{user_id}/activity", tags={"production", "resources", "secure", "user"})
    async def get_user_activity_resource(user_id: str) -> str:
        """
        Get user activity and usage statistics as a resource.
        
        Provides comprehensive user activity metrics and usage statistics.
        Only accessible by the user themselves for privacy.
        
        Args:
            user_id: The ID of the user to get activity for
            
        Returns:
            JSON string containing user activity statistics
        """
        try:
            user_context = get_mcp_user_context()
            
            # Default to current user if user_id is "me"
            target_user_id = user_id if user_id != "me" else user_context.user_id
            
            # Only allow access to own activity
            if target_user_id != user_context.user_id:
                return json.dumps({"error": "Access denied - can only view own activity"}, indent=2)
            
            # Get collections
            users_collection = db_manager.get_collection("users")
            families_collection = db_manager.get_collection("families")
            workspaces_collection = db_manager.get_collection("workspaces")
            
            # Get user data
            user_data = await users_collection.find_one({"_id": target_user_id})
            
            if not user_data:
                return json.dumps({"error": "User not found"}, indent=2)
            
            # Get family activity
            user_families = await families_collection.find({
                "members.user_id": target_user_id
            }).to_list(length=None)
            
            # Get workspace activity
            user_workspaces = await workspaces_collection.find({
                "members.user_id": target_user_id
            }).to_list(length=None)
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="get_user_activity_resource",
                user_context=user_context,
                resource_type="user",
                resource_id=target_user_id,
                metadata={"resource_type": "user_activity"}
            )
            
            # Calculate activity statistics
            now = datetime.utcnow()
            account_age = (now - user_data.get("created_at")).days if user_data.get("created_at") else 0
            
            activity_stats = {
                "user_id": target_user_id,
                "overview": {
                    "account_created": user_data.get("created_at").isoformat() if user_data.get("created_at") else None,
                    "account_age_days": account_age,
                    "last_active": user_data.get("last_active").isoformat() if user_data.get("last_active") else None,
                    "total_logins": user_data.get("login_stats", {}).get("total_logins", 0),
                    "last_login": user_data.get("login_stats", {}).get("last_login").isoformat() if user_data.get("login_stats", {}).get("last_login") else None
                },
                "families": {
                    "total_families": len(user_families),
                    "owned_families": len([f for f in user_families if f.get("owner_id") == target_user_id]),
                    "admin_families": len([f for f in user_families if any(m.get("user_id") == target_user_id and m.get("role") == "admin" for m in f.get("members", []))]),
                    "family_invitations_sent": user_data.get("family_stats", {}).get("invitations_sent", 0),
                    "family_invitations_received": user_data.get("family_stats", {}).get("invitations_received", 0)
                },
                "workspaces": {
                    "total_workspaces": len(user_workspaces),
                    "owned_workspaces": len([w for w in user_workspaces if w.get("owner_id") == target_user_id]),
                    "admin_workspaces": len([w for w in user_workspaces if any(m.get("user_id") == target_user_id and m.get("role") == "admin" for m in w.get("members", []))])
                },
                "sbd_tokens": {
                    "total_earned": user_data.get("sbd_stats", {}).get("total_earned", 0),
                    "total_spent": user_data.get("sbd_stats", {}).get("total_spent", 0),
                    "current_balance": user_data.get("sbd_stats", {}).get("current_balance", 0),
                    "transactions_count": user_data.get("sbd_stats", {}).get("transaction_count", 0)
                },
                "security": {
                    "password_changes": user_data.get("security_stats", {}).get("password_changes", 0),
                    "failed_login_attempts": user_data.get("security_stats", {}).get("failed_logins", 0),
                    "two_factor_enabled": user_data.get("two_factor", {}).get("enabled", False),
                    "security_lockdowns_active": sum([
                        1 if user_data.get("security", {}).get("ip_lockdown", {}).get("enabled") else 0,
                        1 if user_data.get("security", {}).get("user_agent_lockdown", {}).get("enabled") else 0
                    ])
                },
                "generated_at": datetime.utcnow().isoformat()
            }
            
            logger.info("Provided user activity resource for user %s", target_user_id)
            
            return json.dumps(activity_stats, indent=2, default=str)
            
        except Exception as e:
            logger.error("Failed to get user activity resource for %s: %s", user_id, e)
            return json.dumps({"error": f"Failed to retrieve user activity: {str(e)}"}, indent=2)

        else:
        logger.warning("FastMCP not available - user resources will not be registered")