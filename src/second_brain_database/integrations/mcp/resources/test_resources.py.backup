"""
Test MCP Resources for FastMCP 2.0

Simple test resources to validate FastMCP 2.0 integration and functionality.
"""

from typing import Dict, Any
from datetime import datetime, timezone

from ..mcp_instance import get_mcp_server
from ..security import get_mcp_user_context
from ..context import create_mcp_audit_trail
from ....managers.logging_manager import get_logger

logger = get_logger(prefix="[MCP_TestResources]")

# Get the shared MCP server instance
mcp_server = get_mcp_server()

if mcp_server is not None:
    
    @mcp_server.resource("test://status")
    async def test_status_resource() -> Dict[str, Any]:
        """
        Test status resource for FastMCP 2.0 validation.
        
        Returns:
            Current system status information
        """
        try:
            user_context = get_mcp_user_context()
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="test_status_resource",
                user_context=user_context,
                resource_type="resource",
                resource_id="test://status",
                metadata={"resource_type": "status"}
            )
            
            status_info = {
                "uri": "test://status",
                "mimeType": "application/json",
                "text": {
                    "status": "operational",
                    "timestamp": datetime.now(timezone.utc).isoformat(),
                    "fastmcp_version": "2.0",
                    "server_name": "SecondBrainMCP",
                    "user_context": {
                        "user_id": user_context.user_id,
                        "role": user_context.role,
                        "authenticated": True
                    }
                }
            }
            
            logger.info("Test status resource accessed by user %s", user_context.user_id)
            return status_info
            
        except Exception as e:
            logger.error("Test status resource failed: %s", e)
            return {
                "uri": "test://status",
                "mimeType": "application/json",
                "text": {
                    "status": "error",
                    "error": str(e),
                    "timestamp": datetime.now(timezone.utc).isoformat()
                }
            }
    
    @mcp_server.resource("test://info/{info_type}")
    async def test_info_resource(info_type: str) -> Dict[str, Any]:
        """
        Test info resource with parameters for FastMCP 2.0 validation.
        
        Args:
            info_type: Type of information to retrieve
            
        Returns:
            Information based on the requested type
        """
        try:
            user_context = get_mcp_user_context()
            
            # Create audit trail
            await create_mcp_audit_trail(
                operation="test_info_resource",
                user_context=user_context,
                resource_type="resource",
                resource_id=f"test://info/{info_type}",
                metadata={"info_type": info_type}
            )
            
            info_data = {
                "server": {
                    "name": "SecondBrainMCP",
                    "version": "1.0.0",
                    "protocol": "2024-11-05"
                },
                "system": {
                    "timestamp": datetime.now(timezone.utc).isoformat(),
                    "status": "running"
                },
                "user": {
                    "id": user_context.user_id,
                    "role": user_context.role
                }
            }
            
            requested_info = info_data.get(info_type, {"error": f"Unknown info type: {info_type}"})
            
            resource_info = {
                "uri": f"test://info/{info_type}",
                "mimeType": "application/json",
                "text": requested_info
            }
            
            logger.info("Test info resource accessed by user %s for type %s", user_context.user_id, info_type)
            return resource_info
            
        except Exception as e:
            logger.error("Test info resource failed: %s", e)
            return {
                "uri": f"test://info/{info_type}",
                "mimeType": "application/json",
                "text": {
                    "error": str(e),
                    "timestamp": datetime.now(timezone.utc).isoformat()
                }
            }

else:
    logger.warning("FastMCP 2.0 not available - test resources will not be registered")